---
title: "Tracking ecosystem shifts, from microbes to mammals, with environmental DNA"
author: "Anni Djurhuus"
output: html_document
---

```{r setup, include=FALSE}
#knitr::opts_chunk$set(include = FALSE)
library(here); library(plyr); library(biomformat); library(tidyverse); library(phyloseq); library(vegan); library(reshape2); library(MASS); library(stringr); library(purrr); library(ggplot2); library(Hmisc); library(lubridate); library(corrplot); library(gplots); library(rafalib);library(tissuesGeneExpression); library(genefilter); library(RColorBrewer); library(ggdendro);library(ComplexHeatmap); library(circlize); library(colorspace); library(GetoptLong);library(WGCNA); library(matrixStats);library(Hmisc); library(splines);library(foreach);library(doParallel);library(fastcluster) ;library(dynamicTreeCut);library(survival)
```

```{r, include=FALSE}
cbbPalette <- c("#000000", "#E69F00", "#56B4E9", "#009E73", "#F0E442", "#0072B2", "#D55E00", "#CC79A7","red","grey", "grey20")
cbPalette <- c("#999999", "#E69F00", "#56B4E9", "#009E73", "#F0E442", "#0072B2", "#D55E00", "#CC79A7")

add.alpha <- function(col, alpha=1){
  if(missing(col))
    stop("Please provide a vector of colours.")
  apply(sapply(col, col2rgb)/255, 2, 
                     function(x) 
                       rgb(x[1], x[2], x[3], alpha=alpha))  
}
cbbPalette_alpha <- add.alpha(cbbPalette, alpha=0.5)

pal <- colorRampPalette(brewer.pal(11, "RdYlGn"))(50)
```

```{r read in FK and MB data undergone decontamination, include=FALSE}
FK_16S_m2w <- merge_phyloseq(otu_table(as.matrix(read.csv(file = "/Users/anni_djurhuus/Documents/Projects/MBON/m2w/google_drive/data/MEGAN6/post_decont/FK/16S/FK_16S_otu_table.csv", row.names = 1)), taxa_are_rows = TRUE),tax_table(as.matrix(read.csv(file = "/Users/anni_djurhuus/Documents/Projects/MBON/m2w/google_drive/data/MEGAN6/post_decont/FK/16S/FK_16S_taxa_table.csv", row.names = 1))),sample_data(read.csv(file = "/Users/anni_djurhuus/Documents/Projects/MBON/m2w/google_drive/data/MEGAN6/post_decont/FK/16S/FK_16S_sam_table.csv", row.names = 1)))

FK_18S_m2w <- merge_phyloseq(otu_table(as.matrix(read.csv(file = "/Users/anni_djurhuus/Documents/Projects/MBON/m2w/google_drive/data/MEGAN6/post_decont/FK/18S/FK_18S_otu_table.csv", row.names = 1)), taxa_are_rows = TRUE),tax_table(as.matrix(read.csv(file = "/Users/anni_djurhuus/Documents/Projects/MBON/m2w/google_drive/data/MEGAN6/post_decont/FK/18S/FK_18S_tax_table.csv", row.names = 1))),sample_data(read.csv(file = "/Users/anni_djurhuus/Documents/Projects/MBON/m2w/google_drive/data/MEGAN6/post_decont/FK/18S/FK_18S_sam_table.csv", row.names = 1)))

FK_COI_m2w <- merge_phyloseq(otu_table(as.matrix(read.csv(file = "/Users/anni_djurhuus/Documents/Projects/MBON/m2w/google_drive/data/MEGAN6/post_decont/FK/COI/FK_COI_otu_table.csv", row.names = 1)), taxa_are_rows = TRUE),tax_table(as.matrix(read.csv(file = "/Users/anni_djurhuus/Documents/Projects/MBON/m2w/google_drive/data/MEGAN6/post_decont/FK/COI/FK_COI_tax_table.csv", row.names = 1))),sample_data(read.csv(file = "/Users/anni_djurhuus/Documents/Projects/MBON/m2w/google_drive/data/MEGAN6/post_decont/FK/COI/FK_COI_sam_table.csv", row.names = 1)))

#FK_12S_m2w <- merge_phyloseq(otu_table(as.matrix(read.csv(file = "/Users/anni_djurhuus/Documents/Projects/MBON/m2w/google_drive/data/MEGAN6/post_decont/FK/12S/FK_12S_otu_table.csv", row.names = 1)), taxa_are_rows = TRUE),tax_table(as.matrix(read.csv(file = "/Users/anni_djurhuus/Documents/Projects/MBON/m2w/google_drive/data/MEGAN6/post_decont/FK/12S/FK_12S_tax_table.csv", row.names = 1))),sample_data(read.csv(file = "/Users/anni_djurhuus/Documents/Projects/MBON/m2w/google_drive/data/MEGAN6/post_decont/FK/12S/FK_12S_sam_table.csv", row.names = 1)))

MB_16S_m2w <- merge_phyloseq(otu_table(as.matrix(read.csv(file = "/Users/anni_djurhuus/Documents/Projects/MBON/m2w/google_drive/data/MEGAN6/post_decont/MB/16S/MB_16S_otu_table.csv", row.names = 1,check.names = FALSE)), taxa_are_rows = TRUE),tax_table(as.matrix(read.csv(file = "/Users/anni_djurhuus/Documents/Projects/MBON/m2w/google_drive/data/MEGAN6/post_decont/MB/16S/MB_16S_tax_table.csv", row.names = 1))),sample_data(read.csv(file = "/Users/anni_djurhuus/Documents/Projects/MBON/m2w/google_drive/data/MEGAN6/post_decont/MB/16S/MB_16S_sam_table.csv", row.names = 1)))

MB_18S_m2w <- merge_phyloseq(otu_table(as.matrix(read.csv(file = "/Users/anni_djurhuus/Documents/Projects/MBON/m2w/google_drive/data/MEGAN6/post_decont/MB/18S/MB_18S_otu_table.csv", row.names = 1,check.names = FALSE)), taxa_are_rows = TRUE),tax_table(as.matrix(read.csv(file = "/Users/anni_djurhuus/Documents/Projects/MBON/m2w/google_drive/data/MEGAN6/post_decont/MB/18S/MB_18S_taxa_table.csv", row.names = 1))),sample_data(read.csv(file = "/Users/anni_djurhuus/Documents/Projects/MBON/m2w/google_drive/data/MEGAN6/post_decont/MB/18S/MB_18S_sam_table.csv", row.names = 1)))

MB_COI_m2w <- merge_phyloseq(otu_table(as.matrix(read.csv(file = "/Users/anni_djurhuus/Documents/Projects/MBON/m2w/google_drive/data/MEGAN6/post_decont/MB/COI/MB_COI_otu_table.csv", row.names = 1,check.names = FALSE)), taxa_are_rows = TRUE),tax_table(as.matrix(read.csv(file = "/Users/anni_djurhuus/Documents/Projects/MBON/m2w/google_drive/data/MEGAN6/post_decont/MB/COI/MB_COI_taxa_table.csv", row.names = 1))),sample_data(read.csv(file = "/Users/anni_djurhuus/Documents/Projects/MBON/m2w/google_drive/data/MEGAN6/post_decont/MB/COI/MB_COI_sam_table.csv", row.names = 1)))

MB_12S_m2w <- merge_phyloseq(otu_table(read.csv(file = "/Users/anni_djurhuus/Documents/Projects/MBON/m2w/google_drive/data/MEGAN6/post_decont/MB/12S/MB_12S_otu_table.csv", row.names = 1, check.names = FALSE), taxa_are_rows = TRUE), tax_table(as.matrix(read.csv(file = "/Users/anni_djurhuus/Documents/Projects/MBON/m2w/google_drive/data/MEGAN6/post_decont/MB/12S/MB_12S_taxa_table.csv", row.names = 1))), sample_data(read.csv(file = "/Users/anni_djurhuus/Documents/Projects/MBON/m2w/google_drive/data/MEGAN6/post_decont/MB/12S/MB_12S_sam_data.csv",row.names = 1)))
#a<-data.frame(MB_12S_m2w@sam_data)
```

```{r functions for splitting species, adding taxonomy to highest level available and pseudoautocorrelation, include=FALSE,message=FALSE, warning=FALSE}
split_species = function(string, n = 2) {
  splits = str_split(string, "/", n + 1)
  res = map_if(splits, ~length(.x) > 2, ~.x[1:n]) %>%
    map_chr(str_c, collapse = "/")
  return(res)
}

add_taxonomy_column = function(physeq, num_species = 2) {
  tax_df = as.data.frame(tax_table(physeq)) %>%
    rownames_to_column("OTU") %>%
    mutate(Rank7 = split_species(Rank7, n = num_species)) %>%
    mutate(Taxonomy =
             case_when(
               is.na(Rank5)  ~ str_c("o:", Rank4),
               is.na(Rank6)   ~ str_c("f:", Rank5),
               is.na(Rank7) ~ str_c("g:", Rank6)
             )
    )
  
  tax = as.matrix(tax_df[, -1])
  rownames(tax) = tax_df$OTU
  tax_table(physeq) = tax_table(tax)
  
  return(physeq)
}

add_taxonomy_column2 = function(physeq, num_species = 2) {
  tax_df = as.data.frame(tax_table(physeq)) %>%
    rownames_to_column("OTU") %>%
    mutate(Rank7 = split_species(Rank7, n = num_species)) %>%
    mutate(Taxonomy2 =
             case_when(
               is.na(Taxonomy)   ~ str_c("c:", Rank3),
               is.na(Rank6)   ~ str_c(Taxonomy)             
             )
    )
  
  tax = as.matrix(tax_df[, -1])
  rownames(tax) = tax_df$OTU
  tax_table(physeq) = tax_table(tax)
  
  return(physeq)
}

add_taxonomy_column3 = function(physeq, num_species = 2) {
  tax_df = as.data.frame(tax_table(physeq)) %>%
    rownames_to_column("OTU") %>%
    mutate(Rank7 = split_species(Rank7, n = num_species)) %>%
    mutate(Taxonomy3 =
             case_when(
               is.na(Taxonomy2)   ~ str_c("p:", Rank2),
               is.na(Rank6)   ~ str_c(Taxonomy2)             
             )
    )
  
  tax = as.matrix(tax_df[, -1])
  rownames(tax) = tax_df$OTU
  tax_table(physeq) = tax_table(tax)
  
  return(physeq)
}

PA<-function(OTUs, DATES, REFERENCE = 1, METHOD = "euclidian"){

  #library(vegan,verbose = F)
  
  #order(DATES) #make sure these are in chronological order; enforce this rule by re-ordering, like so:
  OTUs<-OTUs[,order(DATES)]
  DATES<-sort(DATES)
  
  referenceTimePoint<-unique(DATES)[REFERENCE] #set a reference time point at a particular sample
  dayVector<-as.numeric(DATES-DATES[match(referenceTimePoint, DATES)]) #time difference in days, relative to reference point
  
  bcdist<-as.matrix(vegan::vegdist(t(OTUs), method=METHOD)) 
    diag(bcdist)<-NA   #don't count self-comparison within replicates
  
    distFUN <- function(x) as.vector(bcdist[DATES==x,DATES==referenceTimePoint]) #function to pull selected distances from matrix
  
  dist.res<-lapply(X=unique(DATES), FUN=distFUN)
    #dist.res<-as.data.frame(t(plyr::ldply(dist.res, rbind)))
    	maxlength<-max(sapply(dist.res, length))		
		for(i in 1:length(dist.res)){length(dist.res[[i]])<-maxlength}	#pad to create even columns
	  dist.res<-as.data.frame(dist.res, check.names=FALSE)	
    names(dist.res)<-unique(dayVector)
    
  return(dist.res)  
  
}

OneStep<-function(OTUs, DATES, METHOD = "euclidian"){
  
  #order(DATES) #make sure these are in chronological order; enforce this rule by re-ordering, like so:
  OTUs<-OTUs[,order(DATES)]
  DATES<-sort(DATES)
  
  dayVector<-as.numeric(unique(DATES)[2:length(unique(DATES))])-
  	as.numeric(unique(DATES)[1:(length(unique(DATES))-1)]) #time difference in days, relative to previous sample

  bcdist<-as.matrix(vegan::vegdist(t(OTUs), method=METHOD)) 
    diag(bcdist)<-NA   #don't count self-comparison within replicates
  
    distFUN <- function(x) as.vector(bcdist[DATES==unique(DATES)[x], DATES==unique(DATES)[x+1]]) #function to pull selected distances from matrix

  dist.res<-lapply(1:(length(unique(DATES))-1), FUN=distFUN)
     	maxlength<-max(sapply(dist.res, length))		
		for(i in 1:length(dist.res)){length(dist.res[[i]])<-maxlength}	#pad to create even columns
	  dist.res<-as.data.frame(dist.res, check.names=FALSE)	
    names(dist.res)<-paste("Step", 1:(length(unique(DATES))-1), dayVector, "Days", sep="_")
   
  return(dist.res) 
}


multiplot <- function(..., plotlist=NULL, file, cols=1, layout=NULL) {
  library(grid)
  
  # Make a list from the ... arguments and plotlist
  plots <- c(list(...), plotlist)
  
  numPlots = length(plots)
  
  # If layout is NULL, then use 'cols' to determine layout
  if (is.null(layout)) {
    # Make the panel
    # ncol: Number of columns of plots
    # nrow: Number of rows needed, calculated from # of cols
    layout <- matrix(seq(1, cols * ceiling(numPlots/cols)),
                     ncol = cols, nrow = ceiling(numPlots/cols))
  }
  
  if (numPlots==1) {
    print(plots[[1]])
    
  } else {
    # Set up the page
    grid.newpage()
    pushViewport(viewport(layout = grid.layout(nrow(layout), ncol(layout))))
    
    # Make each plot, in the correct location
    for (i in 1:numPlots) {
      # Get the i,j matrix positions of the regions that contain this subplot
      matchidx <- as.data.frame(which(layout == i, arr.ind = TRUE))
      
      print(plots[[i]], vp = viewport(layout.pos.row = matchidx$row,
                                      layout.pos.col = matchidx$col))
    }
  }
}
```

```{r transform sample abundance to proportion and make one dataframe per location, include=FALSE}
FK_16S_fam <- tax_glom(FK_16S_m2w, "Rank5")
FK_18S_fam <- tax_glom(FK_18S_m2w, "Rank5")
FK_COI_fam <- tax_glom(FK_COI_m2w, "Rank5")
#FK_12S_fam <- tax_glom(FK_12S_m2w, "Rank5")

MB_16S_fam <- tax_glom(MB_16S_m2w, "Rank5")
MB_18S_fam <- tax_glom(MB_18S_m2w, "Rank5")
MB_COI_fam <- tax_glom(MB_COI_m2w, "Rank5")
MB_12S_fam <- tax_glom(MB_12S_m2w, "Rank5")

tax_table(FK_16S_fam) <- gsub('f_', as.character(NA), gsub('o_', as.character(NA), gsub('c_',as.character(NA), gsub('p_', as.character(NA),gsub('unknown', as.character(NA), tax_table(FK_16S_fam))))))
FK_16S_fam <- add_taxonomy_column(FK_16S_fam)
FK_16S_fam <- add_taxonomy_column2(FK_16S_fam)
FK_16S_fam <- add_taxonomy_column3(FK_16S_fam)
FK_16S_fam <- subset_taxa(FK_16S_fam,Taxonomy3 !="NA")
FK_16S_fam <- tax_glom(FK_16S_fam,"Taxonomy3")
taxa_names(FK_16S_fam) <- paste(FK_16S_fam@tax_table[,10])
FK_16S_prop = transform_sample_counts(FK_16S_fam,function(x) x / sum(x))

tax_table(FK_18S_fam) <- gsub('f_', as.character(NA), gsub('o_', as.character(NA), gsub('c_',as.character(NA), gsub('p_', as.character(NA), gsub('unknown', as.character(NA),tax_table(FK_18S_fam))))))
FK_18S_fam <- add_taxonomy_column(FK_18S_fam)
FK_18S_fam <- add_taxonomy_column2(FK_18S_fam)
FK_18S_fam <- subset_taxa(FK_18S_fam,Taxonomy2 !="NA")
FK_18S_fam <- tax_glom(FK_18S_fam,"Taxonomy2")
taxa_names(FK_18S_fam) <- paste(FK_18S_fam@tax_table[,9])
FK_18S_prop = transform_sample_counts(FK_18S_fam,function(x) x / sum(x))

tax_table(FK_COI_fam) <- gsub('f_', as.character(NA), gsub('o_', as.character(NA), gsub('c_',as.character(NA), gsub('p_', as.character(NA), gsub('unknown', as.character(NA),tax_table(FK_COI_fam))))))
FK_COI_fam <- add_taxonomy_column(FK_COI_fam)
FK_COI_fam <- add_taxonomy_column2(FK_COI_fam)
FK_COI_fam <- subset_taxa(FK_COI_fam,Taxonomy2 !="NA")
FK_COI_fam <- tax_glom(FK_COI_fam,"Taxonomy2")
taxa_names(FK_COI_fam) <- paste(FK_COI_fam@tax_table[,9])
FK_COI_prop = transform_sample_counts(FK_COI_fam,function(x) x / sum(x))

#tax_table(FK_12S_fam) <- gsub('f_', as.character(NA), gsub('o_', as.character(NA), gsub('c_',as.character(NA), gsub('p_', as.character(NA), gsub('unknown', as.character(NA),tax_table(FK_12S_fam))))))
# FK_12S_fam <- add_taxonomy_column(FK_12S_fam)
# FK_12S_fam <- add_taxonomy_column2(FK_12S_fam)
# FK_12S_fam <- subset_taxa(FK_12S_fam,Taxonomy2 !="NA")
# FK_12S_fam <- tax_glom(FK_12S_fam,"Taxonomy2")
# taxa_names(FK_12S_fam) <- paste(FK_12S_fam@tax_table[,9])
# FK_12S_prop = transform_sample_counts(FK_12S_fam,function(x) x / sum(x))

#Merge all data for FKNMS
FK_all_tax_ps <- merge_phyloseq(FK_COI_fam@otu_table,FK_16S_fam@otu_table,
                        FK_18S_fam@otu_table,FK_18S_fam@sam_data)
FK_all_tax_ps_ts <- merge_phyloseq(FK_COI_prop@otu_table,FK_16S_prop@otu_table,
                                FK_18S_prop@otu_table,FK_18S_fam@sam_data)
FK_all_tax_ps_ts_merge <- merge_samples(FK_all_tax_ps_ts,"collection_date",fun=mean) #merge samples

badTaxa_FK = c("f:no hits", "f:Bovidae", "f:not assigned", "o:Diptera", "f:Hominidae", "c:Insecta")
goodTaxa_FK <- setdiff(taxa_names(FK_all_tax_ps), badTaxa_FK)
FK_all_tax_ps_nonrel = prune_taxa(goodTaxa_FK,FK_all_tax_ps)
FK_all_tax_ps_ts_merge = prune_taxa(goodTaxa_FK,FK_all_tax_ps_ts_merge)
FK_all_tax_df <- data.frame(t(FK_all_tax_ps_nonrel@otu_table))
FK_all_tax_tf = transform_sample_counts(FK_all_tax_ps_nonrel,function(x) x / sum(x))
FK_all_tax <- data.frame(FK_all_tax_tf@otu_table)
FK_all_tax_t <- data.frame(FK_all_tax_ps_nonrel@otu_table)
#write.csv(FK_all_tax, "/Users/anni_djurhuus/Documents/Projects/MBON/m2w/google_drive/data/MEGAN6/post_decont/FK/FK_all_taxa.csv")  #is this the best way to save biom files?
FK_all_ps_merge <- merge_samples(FK_all_tax_tf,"collection_date",fun=mean) #merge samples
FK_all_merge <- data.frame(FK_all_ps_merge@otu_table) # Make dataframe in case it is needed
FK_all_merge$collection_date <- row.names(FK_all_merge) # paste date into 

#Monterey Bay
tax_table(MB_16S_fam) <- gsub('f_', as.character(NA), gsub('o_', as.character(NA), gsub('c_',as.character(NA), gsub('p_', as.character(NA),gsub('unknown', as.character(NA), tax_table(MB_16S_fam))))))
MB_16S_fam <- add_taxonomy_column(MB_16S_fam)
MB_16S_fam <- add_taxonomy_column2(MB_16S_fam)
MB_16S_fam <- subset_taxa(MB_16S_fam,Taxonomy2 !="NA")
MB_16S_fam <- tax_glom(MB_16S_fam,"Taxonomy2")
taxa_names(MB_16S_fam) <- paste(MB_16S_fam@tax_table[,9])
MB_16S_prop = transform_sample_counts(MB_16S_fam,function(x) x / sum(x))

tax_table(MB_18S_fam) <- gsub('f_', as.character(NA), gsub('o_', as.character(NA), gsub('c_',as.character(NA), gsub('p_', as.character(NA), gsub('unknown', as.character(NA),tax_table(MB_18S_fam))))))
MB_18S_fam <- add_taxonomy_column(MB_18S_fam)
MB_18S_fam <- add_taxonomy_column2(MB_18S_fam)
MB_18S_fam <- subset_taxa(MB_18S_fam,Taxonomy2 !="NA")
MB_18S_fam <- tax_glom(MB_18S_fam,"Taxonomy2")
taxa_names(MB_18S_fam) <- paste(MB_18S_fam@tax_table[,9])
MB_18S_prop = transform_sample_counts(MB_18S_fam,function(x) x / sum(x))

tax_table(MB_COI_fam) <- gsub('f_', as.character(NA), gsub('o_', as.character(NA), gsub('c_',as.character(NA), gsub('p_', as.character(NA), gsub('unknown', as.character(NA),tax_table(MB_COI_fam))))))
MB_COI_fam <- add_taxonomy_column(MB_COI_fam)
MB_COI_fam <- add_taxonomy_column2(MB_COI_fam)
MB_COI_fam <- subset_taxa(MB_COI_fam,Taxonomy2 !="NA")
MB_COI_fam <- tax_glom(MB_COI_fam,"Taxonomy2")
taxa_names(MB_COI_fam) <- paste(MB_COI_fam@tax_table[,9])
MB_COI_prop = transform_sample_counts(MB_COI_fam,function(x) x / sum(x))

tax_table(MB_12S_fam) <- gsub('f_', as.character(NA), gsub('o_', as.character(NA), gsub('c_',as.character(NA), gsub('p_', as.character(NA), gsub('unknown', as.character(NA),tax_table(MB_12S_fam))))))
MB_12S_fam <- add_taxonomy_column(MB_12S_fam) # Add family and order assignments 
MB_12S_fam <- add_taxonomy_column2(MB_12S_fam) # Add class and phylum assignments
MB_12S_fam <- subset_taxa(MB_12S_fam,Taxonomy2 !="NA") #get rid of all NAs in dataset.
taxa_names(MB_12S_fam) <- paste(MB_12S_fam@tax_table[,9])
MB_12S_prop = transform_sample_counts(MB_12S_fam,function(x) x / sum(x))

#Merge all data from MB
MB_all_tax_ps <- merge_phyloseq(MB_COI_fam@otu_table,MB_16S_fam@otu_table,
                                MB_12S_fam@otu_table,MB_18S_fam@otu_table, MB_18S_fam@sam_data)
MB_all_tax_ps_ts <- merge_phyloseq(MB_COI_prop@otu_table,MB_16S_prop@otu_table,
                                MB_12S_prop@otu_table,MB_18S_prop@otu_table, MB_18S_fam@sam_data) #merge data on previously transformed data.
MB_all_tax_ps_ts_merge <- merge_samples(MB_all_tax_ps_ts,"collection_date",fun=mean) #merge samples

badTaxa_MB = c("f:no hits", "f:Bovidae", "f:not assigned", "o:Diptera","f:Hominidae","c:Insecta")
goodTaxa_MB <- setdiff(taxa_names(MB_all_tax_ps), badTaxa_MB)
MB_all_tax_ps_nonrel = prune_taxa(goodTaxa_MB,MB_all_tax_ps)
MB_all_tax_ps_ts_merge = prune_taxa(goodTaxa_MB,MB_all_tax_ps_ts_merge)
MB_all_tax_tf = transform_sample_counts(MB_all_tax_ps_nonrel,function(x) x / sum(x))
MB_all_tax_df <- data.frame(t(MB_all_tax_ps_nonrel@otu_table))
#write.csv(MB_all_tax, "/Users/anni_djurhuus/Documents/Projects/MBON/m2w/google_drive/data/MEGAN6/post_decont/MB/MB_all_taxa.csv")  #is this the best way to save biom files?
MB_all_ps_merge <- merge_samples(MB_all_tax_tf,"collection_date",fun=mean) #merge samples
MB_all_merge <- data.frame(MB_all_ps_merge@otu_table) # Make dataframe in case it is needed
MB_all_merge$collection_date <- row.names(MB_all_merge) # paste date into 
```

##### To do list:
1. Make networks (WGCNA)
2. Assign trophic level to groups
3. Prettify figures
4. Write results and discussion

##### General guidelines for Nature manuscripts:
-Manuscript do not normally exceed 5 pages of Nature

-Up to 50 references (One page of undiluted text is about 1,300 words.)

-Summary up to 150 words: This summary contains a paragraph (2-3 sentences) of basic-level introduction to the field; a brief account of the background and rationale of the work; a statement of the main conclusions (introduced by the phrase 'Here we show' or its equivalent); and finally, 2-3 sentences putting the main findings into general context so it is clear how the results described in the paper have moved the field forwards.

-Main text of no more than 3,500 words and 6 display items (figures, tables).

-Statistical information: Comprehensive information on the statistical analyses used must be included in the paper. The Methods must include a statistics section where you describe the statistical tests used and whether they were one- or two-tailed. Please ensure that the error bars are defined throughout the figures. For all statistics (including error bars), provide the EXACT n values used to calculate the statistics. Where relevant, provide exact values for both significant and non-significant P values. For ANOVAs, provide F values and degrees of freedom. For t-tests, provide t-values and degrees of freedom. Please specifically define the replicates.

##### Hypotheses and Notes
There are wholesale shifts in the ecosystem from one state to another more than once for both MB and FK. 
For MB there is a tradeoff between anchovy- and sardine- dominated signals. There are mainly two-three phases, 1: April - July 2015, 2: July 2015 - January 2016, 3: January - September 2016. In Monterey Bay, krill (Euphausiidae) are in the first set of dates, and disappear in the second; Cyclopid copepods (Cyclopidae) do the opposite.  Temoridae peak in the transitional time between these hypothesized states.  Diatom-wise, Thalassiosiraceae and Chaetocerotaceaeoccurs are present mostly in the beginning and then during the second phase, but nearly absent between them.  Rhizosoleniaceae is in the second time period, but not the first.  Re: Annelids, Echiurids in the second phase, spionids during the transition. Balaenoptera in the first period only. Overall there seems to be a quite distinct difference between the winter --> spring and summer --> autumn communities. 
Thalassiosira and chaetoceros are strongly positively correlated with paracalanus, which are all negatively correlated with the coccolithophores, pelagibacter, and engraulidae. The Clupeidae are not really correlated with anything and the whales are definitely present during the peak of Engraulidae. 


For FK, there is more variation in the community, but still a few distinct periods. 1: April-September 2015, 2: September 2015 - March 2016, 3: March 2016 - September 2016.
Interestingly all the jellies seem to be correlated to the same organisms, such as some phytoplankton taxa.


###Main (Introduction)
Global change in climate, environments, and shifts in biodiversity distribution necessitate assessments to provide a baseline measure to gauge undergoing changes. Traditionally marine biodiversity assessments are conducted via methods, such as trawling or aerial surveys focusing on macro-organisms. More recently global and local assessments have been conducted to explore microbial communities unveiling the vast microbial diversity that exists. Cross trophic level assessments of biodiversity are rarely conducted, and the simultaneous biodiversity fluxes from microorganisms to macro-organisms over temporal scales are non-existing. Though it is with temporal studies where natural fluxes and changes in the biodiversity can be addressed.

Whether due to anthropogenic or natural disturbances there is a general trend of biodiversity decline (Butchart et al, 2010), which needs to be monitored. Efforts to assess these changes and declines in biodiversity have not yet connected trophic levels to understand the total community impact. The genetic trace of an organism in a given environment, referred to as environmental DNA (eDNA), allows for the detection of that organism within that environment. This method has been applied in microbial ecology in many terrestrial and aquatic studies and has been more recently become an accepted standard for detection of eukaryotic organisms.

###Results
##### Seasonal trends
We performed a pearson correlation on number of taxa with temperature and chlorophyll a for total taxa and each genetic marker separately for both locations. The only significant correlations observed were for 16S with chlorophyll a for both locations (p<0.05).

<!--###Pseudo-autocorrelation
From a pseudo-autocorrelation test (Kelly et al. 2018, PeerJ) we saw that the communities between samples have significant changes with time. Based on the entire dataset the period post to July 2015...-->

```{r Richness of total taxa, echo=FALSE, fig.cap="\\label{fig:fig 1}Figure 1: A (FK) and B (MB): Total richness (number of taxa) in the Florida Keys National Marine Sanctuary and Monterey Bay National Marine Sanctuary through April 2015 - December 2016 with sea surface temperature anomaly. C (FK) and D (MB) are Pseudo-autocorrelation analyses across all taxa compared to the time point ahead of it. First time point is zero due to not having a reference point prior to it. The vertical dashed line represents December 31, 2015.", fig.height=8, fig.width=6.5}
par(mfrow=c(2,2))
par(mar=c(0,5,4,0))
richness_total_FK <- setNames(cbind(estimate_richness(FK_all_tax_ps_nonrel, measures="Observed"),FK_all_tax_ps_nonrel@sam_data$collection_date, FK_all_tax_ps_nonrel@sam_data$locus),c("richness","YEAR_DATE", "locus"))
boxplot(richness_total_FK$richness~ymd(richness_total_FK$YEAR_DATE),
        main="", at=c(1,3,6,8,10,12,14,16,18,20), xlim=c(0,21),cex.axis = 0.8, las=2, ylim=c(0,350),
       xaxt="n",col="grey90",ylab=c("Number of taxa"))
abline(v=c(10), col=c("black"), lty=c(2), lwd=c(1))
#axis(side=1, at=c(1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21),
     #labels=c("Apr", "May", "June", "July", "Aug","Sep", "Oct", "Nov", "Dec", "Jan", "Feb","Mar",
      #        "Apr", "May", "June", "July", "Aug","Sep", "Oct", "Nov", "Dec"), las=3,cex.axis=0.7)
#mtext("2015", side=1, line=3, at=4,cex=0.8)
#mtext("2016", side=1, line=3, at=16,cex=0.8)
env_FK <- read.csv("/Users/anni_djurhuus/Documents/Projects/MBON/m2w/env_data/WS_FKNMS_GHRSST_15_16.csv", header=TRUE)
par(new=TRUE)
plot(env_FK$Anomaly~dmy(env_FK$Date),type="l",ylim=c(-1,5), lwd=5,xlab="", ylab="",yaxt="n",xaxt="n",col=alpha("grey",0.5))
legend("topleft", "A", bty="n")

#MB
par(mar=c(0,1,4,4))
richness_total_MB <- setNames(cbind(estimate_richness(MB_all_tax_ps_nonrel, measures="Observed"),MB_all_tax_ps_nonrel@sam_data$collection_date, MB_all_tax_ps_nonrel@sam_data$locus),c("richness","YEAR_DATE", "locus"))
boxplot(richness_total_MB$richness~ymd(richness_total_MB$YEAR_DATE),
        main="", at=c(1,4,7,9,13,17,18,21), cex.axis = 0.8,xlim=c(0,21), las=2, ylim=c(0,350),yaxt="n",
       xaxt="n",col="grey90",ylab=c("Number of taxa"))
abline(v=c(10), col=c("black"), lty=c(2), lwd=c(1))
#axis(side=1, at=c(1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21),
 #    labels=c("Apr", "May", "June", "July", "Aug","Sep", "Oct", "Nov", "Dec", "Jan", "Feb","Mar",
  #            "Apr", "May", "June", "July", "Aug","Sep", "Oct", "Nov", "Dec"), las=3,cex.axis=0.7)
#mtext("2015", side=1, line=3, at=4,cex=0.8)
#mtext("2016", side=1, line=3, at=16,cex=0.8)
env_MB <- read.csv("/Users/anni_djurhuus/Documents/Projects/MBON/m2w/env_data/MBNMS_GHRSST_15_16.csv", header=TRUE)
par(new=TRUE)
plot(env_MB$Anomaly~dmy(env_MB$Date),type="l",ylim=c(-1,5), lwd=5,xlab="", ylab="",yaxt="n",xaxt="n",col=alpha("grey",0.5))
axis(side=4)
mtext("Sea surface anomaly",side=4,line=1.9,las=3)
legend("topleft", "B", bty="n")


#PA
OTUs_MB<-otu_table(MB_all_tax_ps_ts)
dates_MB<-ymd(sample_data(MB_all_tax_ps_ts)$collection_date)
dist.res_MB_sa <- OneStep(OTUs=OTUs_MB, DATES=dates_MB, METHOD="jaccard")

OTUs_FK<-otu_table(FK_all_tax_ps_ts)
dates_FK<-ymd(sample_data(FK_all_tax_ps_ts)$collection_date)
dist.res_FK_sa <- OneStep(OTUs=OTUs_FK, DATES=dates_FK, METHOD="jaccard")

#plot object in base R
#par(mfcol=c(1,2))
par(mar=c(4,5,1,0))
boxplot(dist.res_FK_sa, xaxt="n",ylim=c(0,1),at=c(3,6,8,10,12,14,16,18,20), cex.axis = 0.8, las=2,main="",col="grey90",xlim=c(0,21), ylab= "Euclidean Distance", ylim=c(0,1))
par(mar=c(4,1,1,4))
abline(v=c(10), col=c("black"), lty=c(2), lwd=c(1))
axis(side=1, at=c(1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21),
     labels=c("Apr", "May", "June", "July", "Aug","Sep", "Oct", "Nov", "Dec", "Jan", "Feb","Mar",
              "Apr", "May", "June", "July", "Aug","Sep", "Oct", "Nov", "Dec"), las=3,cex.axis=0.7)
mtext("2015", side=1, line=3, at=4,cex=0.8)
mtext("2016", side=1, line=3, at=16,cex=0.8)
legend("topleft", "C", bty="n")
boxplot(dist.res_MB_sa, at=c(4,7,9,13,17,18,21),xlim=c(0,21),xlab="", ylab="Euclidian Distance", xlim=c(0,21.5), ylim=c(0,1), col="grey90",xaxt="n",yaxt="n")
abline(v=c(10), col=c("black"), lty=c(2), lwd=c(1))
axis(side=1, at=c(1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21),
     labels=c("Apr", "May", "June", "July", "Aug","Sep", "Oct", "Nov", "Dec", "Jan", "Feb","Mar",
              "Apr", "May", "June", "July", "Aug","Sep", "Oct", "Nov", "Dec"), las=3,cex.axis=0.7)
mtext("2015", side=1, line=3, at=4,cex=0.8)
mtext("2016", side=1, line=3, at=16,cex=0.8)
legend("topleft", "D", bty="n")
```

```{r heatmap of top taxa, echo=FALSE, fig.cap="\\label{fig:fig 2}Figure 2: Dendrogram of the top 50 taxa for FK left and MB right. Dissimilarity between taxa was calculated based on a Euclidean distance matrix.", fig.height=8, fig.width=10, message=FALSE, warning=FALSE}
top_50_FK <- prune_taxa(names(sort(taxa_sums(FK_all_tax_ps_ts_merge),
         TRUE)[1:50]),FK_all_tax_ps_ts_merge)
top_50_MB <- prune_taxa(names(sort(taxa_sums(MB_all_tax_ps_ts_merge),
         TRUE)[1:50]),MB_all_tax_ps_ts_merge)

pushViewport(viewport(x = 0, width = 0.53, just = "left"))
draw(Heatmap(t(data.frame(top_50_FK@otu_table)),clustering_distance_rows = "euclidean",clustering_method_rows ="centroid", row_names_gp = gpar(fontsize = 8),row_title_gp=gpar(fontsize=8),km_title = "cluster% i",column_title_gp = gpar(fontsize = 8),column_dend_height = unit(6, "mm"),column_names_gp = gpar(fontsize = 8),col=pal,name = "FK"), k=4, newpage = FALSE)
popViewport()

pushViewport(viewport(x = 1, width = 0.45, just = "right"))
draw(Heatmap(t(data.frame(top_50_MB@otu_table)),row_names_gp = gpar(fontsize = 8),col=pal,column_title_gp = gpar(fontsize = 8),clustering_distance_rows = "euclidean",column_dend_height = unit(6, "mm"),column_names_gp = gpar(fontsize = 8),row_title_gp=gpar(fontsize=8),km_title = "cluster% i", name = "MB"),k=4, newpage = FALSE)
popViewport()

```

```{r line plots, echo=FALSE, fig.cap="\\label{fig:fig 3}Figure 3: Some of the co-occuring organisms with the highest correlations from FKNMS (left) and MBNS (right).", fig.height=5.5, fig.width=5.5, message=FALSE, warning=FALSE}
#FK_all_merge$collection_date <- ymd(FK_all_merge$collection_date)
#FK_all_merge <- arrange(FK_all_merge, collection_date)
par(mfcol=c(2,2))
par(mar=c(1,4,3,1))
plot(FK_all_merge$f.Noelaerhabdaceae/max(FK_all_merge$f.Noelaerhabdaceae)~ymd(FK_all_merge$collection_date),col="#E69F00",type="l", cex.axis=0.8,pch=16,lwd=2,ylab=c("Relative taxa abundance"), xlab="",xaxt="n",ylim=c(0,1.2))
lines(FK_all_merge$f.Pelagibacteraceae/max(FK_all_merge$f.Pelagibacteraceae)~ymd(FK_all_merge$collection_date), col="gold", pch=16, lwd=2)
lines(FK_all_merge$f.Phaeocystaceae/max(FK_all_merge$f.Phaeocystaceae)~ymd(FK_all_merge$collection_date),lwd=2, col="darkorange3")
lines(FK_all_merge$f.Flavobacteriaceae/max(FK_all_merge$f.Flavobacteriaceae)~ymd(FK_all_merge$collection_date),lwd=2, col="black")
lines(FK_all_merge$f.Acartiidae/max(FK_all_merge$f.Acartiidae)~ymd(FK_all_merge$collection_date),lwd=1.5, col="grey90")
legend("topleft",legend=c("Noelaerhab.", "Pelagibacter","Phaeocystaceae","Flavobacter.","Acartiidae"),ncol=2,col=c("#E69F00","gold","darkorange3","black","grey90"), bty="n", lty=c(1,1,1), cex=0.6)
abline(v=c(16805), col=c("black"), lty=c(2), lwd=c(1))

par(mar=c(4,4,0,1))
plot(FK_all_merge$f.Oithonidae/max(FK_all_merge$f.Oithonidae)~ymd(FK_all_merge$collection_date), cex.axis=0.8,col="darkolivegreen3", pch=16, lwd=2,xlab="", ylab=c("Relative taxa abundance"),ylim=c(0,1.2),xaxt="n",type="l")
lines(FK_all_merge$o.Telonemida/max(FK_all_merge$o.Telonemida)~ymd(FK_all_merge$collection_date), col="#009E73", pch=16, lwd=2)
lines(FK_all_merge$f.Centropagidae/max(FK_all_merge$f.Centropagidae)~ymd(FK_all_merge$collection_date), col="darkolivegreen", pch=16, lwd=2)
axis(1, ymd(FK_all_merge$collection_date), format(ymd(FK_all_merge$collection_date), "%b"), cex.axis = .7, las=3)
legend("topleft",legend=c("Oithonidae", "Telonemida","Centropagidae"), col=c("darkolivegreen3","#009E73","darkolivegreen", "grey"), ncol=1, bty="n", lty=c(1,1,1), cex=0.6)
abline(v=c(16805), col=c("black"), lty=c(2), lwd=c(1))
mtext("2015", side=1, line=3, at=16650,cex=0.7)
mtext("2016", side=1, line=3, at=17000,cex=0.7)

#MB
MB_all_merge$collection_date <- ymd(MB_all_merge$collection_date)
MB_all_merge <- arrange(MB_all_merge, collection_date)
par(mar=c(1,1,3,4))
plot(MB_all_merge$f.Noelaerhabdaceae/max(MB_all_merge$f.Noelaerhabdaceae)~MB_all_merge$collection_date,col="#E69F00",type="l", pch=16,lwd=2,ylab=c(""), xlab="",xaxt="n",yaxt="n",ylim=c(0,1.2))
lines(MB_all_merge$f.Pelagibacteraceae/max(MB_all_merge$f.Pelagibacteraceae)~MB_all_merge$collection_date, col="gold", pch=16, lwd=2)
lines(MB_all_merge$f.Engraulidae/max(MB_all_merge$f.Engraulidae)~MB_all_merge$collection_date,lwd=2, col="darkorange3")
lines(MB_all_merge$f.Balaenopteridae/max(MB_all_merge$f.Balaenopteridae)~MB_all_merge$collection_date,lwd=2, col="black")
legend("topleft",legend=c("Noelaerhab.", "Pelagibacter","Engraulidae","Balaenoptera"),ncol=2,col=c("#E69F00","gold","darkorange3","black"), bty="n", lty=c(1,1,1), cex=0.6)
abline(v=c(16805), col=c("black"), lty=c(2), lwd=c(1))
par(mar=c(4,1,0,4))
plot(MB_all_merge$f.Paracalanidae/max(MB_all_merge$f.Paracalanidae)~MB_all_merge$collection_date, col="darkolivegreen3", pch=16, lwd=2,xlab="", xaxt="n",ylab=c(""),yaxt="n",ylim=c(0,1.2),type="l")
lines(MB_all_merge$f.Thalassiosiraceae/max(MB_all_merge$f.Thalassiosiraceae)~MB_all_merge$collection_date, col="#009E73", pch=16, lwd=2)
lines(MB_all_merge$f.Chaetocerotaceae/max(MB_all_merge$f.Chaetocerotaceae)~MB_all_merge$collection_date, col="darkolivegreen", pch=16, lwd=2)
lines(MB_all_merge$f.Clupeidae/max(MB_all_merge$f.Clupeidae)~MB_all_merge$collection_date,lwd=2, col="grey")
axis(1, ymd(MB_all_merge$collection_date), format(ymd(MB_all_merge$collection_date), "%b"), cex.axis = .7, las=3)
legend("topleft",legend=c("Paracalanidae", "Thalassiosir.","Chaetoceros", "Clupeidae"),col=c("darkolivegreen3","#009E73","darkolivegreen", "grey"), bty="n", ncol=2,lty=c(1,1,1), cex=0.6)
abline(v=c(16805), col=c("black"), lty=c(2), lwd=c(1))
mtext("2015", side=1, line=3, at=16650,cex=0.7)
mtext("2016", side=1, line=3, at=17000,cex=0.7)
```

```{r plots of correlations, echo=FALSE, fig.cap="\\label{fig:fig 4}Figure 4: Correlation of the top 50 taxa for Florida Keys (top) and Monterey Bay (bottom)  only including significant values of a p-value equal to or less than 0.05. These correlation matrices were performed on relative abundance data and ordered by hierarcical clustering on dissimilarities between taxa", fig.height=17, fig.width=10, message=FALSE, warning=FALSE}
par(mfrow=c(2,1))
top_taxa_merge_FK <- prune_taxa(names(sort(taxa_sums(FK_all_tax_ps_ts_merge),
          TRUE)[1:50]),FK_all_tax_ps_ts_merge)
cor_FK <- as.matrix(top_taxa_merge_FK@otu_table)
correlation_FK <-cor(cor_FK)
res2_FK<-rcorr(cor_FK)
corrplot(res2_FK$r, type="upper", order="hclust", 
         p.mat = res2_FK$P, sig.level = 0.05, tl.srt=45,tl.col="black", insig = "blank",tl.cex=0.4,diag=FALSE)

#MB
top_taxa_merge_MB <- prune_taxa(names(sort(taxa_sums(MB_all_tax_ps_ts_merge),
         TRUE)[1:50]),MB_all_tax_ps_ts_merge) #use transformed merged data
cor_MB <- as.matrix(top_taxa_merge_MB@otu_table)
correlation_MB <-cor(cor_MB)
res2_MB<-rcorr(cor_MB)
corrplot(res2_MB$r, type="lower", order="hclust", 
         p.mat = res2_MB$P, sig.level = 0.05, tl.srt=45,tl.col="black", insig = "blank",tl.cex=0.4,diag=FALSE)

```

```{r Ordinations, message=FALSE, warning=FALSE, include=FALSE}
vegdist_MB <- vegdist(MB_all_tax_df, method="jaccard") # Bray-Curtis distances between the rows
metaMDS_MB <- metaMDS(vegdist_MB,verbose = FALSE) # k is the number of dim
#metaMDS_MB # view results
# plot solution phytoplankton
x_MB <- metaMDS_MB$points[,1]
y_MB <- metaMDS_MB$points[,2]

vegdist_FK <- vegdist(FK_all_tax_df, method="jaccard") # Bray-Curtis distances between the rows
metaMDS_FK <- metaMDS(vegdist_FK,verbose = FALSE) # k is the number of dim
# plot solution phytoplankton
x_FK <- metaMDS_FK$points[,1]
y_FK <- metaMDS_FK$points[,2]

all_data <- merge_phyloseq(MB_all_tax_ps_ts,FK_all_tax_ps_ts)
all_Data.ord <- ordinate(all_data, "NMDS", "jaccard")
```

```{r plot ordinations, echo=FALSE, fig.cap="\\label{fig:fig 5}Figure 5: Canonical correspondence analysis of both locations FK (left) and MB (right). The points are colored by replicate with point type representing year (2015=square, 2016=circle). The text is sample collection date. Distance matrix is jaccard.", fig.height=4, fig.width=6, message=FALSE, warning=FALSE}
par(mfrow=c(1,2))
par(mar=c(4,5,2,0))
plot(x_FK, y_FK,xlab="Coordinate 1", main="", ylab="Coordinate 2",col=c(cbbPalette[FK_18S_fam@sam_data$collection_date]),pch=c(15,19)[as.factor(FK_18S_fam@sam_data$year)])
text(x_FK, y_FK,label=FK_18S_fam@sam_data$collection_date,cex=0.5)
sam_FK_df <- data.frame(FK_18S_fam@sam_data)
expl_FK <- subset(sam_FK_df, select=c("TMP_C","CHL_MG_M.3","NO3_um"))
plot(envfit(metaMDS_FK, expl_FK),col="black", cex=0.5)
legend("topleft", "A", bty="n")

par(mar=c(4,1,2,4))
plot(x_MB, y_MB, xlab="Coordinate 1", main="", yaxt="n",ylab="Coordinate 2",col=c(cbbPalette[MB_18S_fam@sam_data$collection_date]),pch=c(15,19)[as.factor(MB_18S_fam@sam_data$year)])
text(x_MB, y_MB,label=MB_18S_fam@sam_data$collection_date,cex=0.5)
sam_MB_df <- data.frame(MB_18S_fam@sam_data)
expl_MB <- subset(sam_MB_df, select=c("temp","nitrate","salinity","chlorophyll"))
plot(envfit(metaMDS_MB, expl_MB),col="black",cex=0.5)
legend("topleft", "B", bty="n")
```

##Methods 
(The combined methods are kept in a different document)

####Method for determining BLAST cutoff and MEGAN annotations
Initial BLAST runs were performed at relaxed parameters for each loci (e.g. 12S = 80%ID & 140 bitscore). Annotations in the resulting xml file were filtered, where the top BLAST hit was accepted as the top annotation for each OTU, as well as additional top hits if the annotations differed for either rank of genus or species. Filtered annotations were plotted by corresponding bitscore to note the range of bitscores and the peak was chosen as the range limit. Bitscores and %IDs were plotted and the intersection at which %ID and the peak bitscore crossed was selected as our %ID lower limit. These more restrictive limits were the subsequent parameters when ultimately determining OTU annotations in MEGAN6. 


### Supplementary Figures
Supplementary figures based to the Microbes to Mammals manuscript.
```{r plotting richness based on family FK, echo=F, fig.width=8, fig.height=5, fig.cap="\\label{fig:figS1}Figure S1: Relative number of taxa for all loci (16S, 18S, COI, and 12S). A: Florida Keys National Marine Sanctuary (FKNMS) and B: Monterey Bay National Marine Sanctuary (MBNMS) from April 2015 - December 2016"}
richness_16S_FK <- setNames(cbind(estimate_richness(FK_16S_fam, measures="Observed"),FK_16S_fam@sam_data$collection_date, FK_16S_fam@sam_data$locus),c("richness","YEAR_DATE", "locus"))
richness_18S_FK <- setNames(cbind(estimate_richness(FK_18S_fam, measures="Observed"),FK_18S_fam@sam_data$collection_date, FK_18S_fam@sam_data$locus),c("richness","YEAR_DATE", "locus"))
richness_COI_FK <- setNames(cbind(estimate_richness(FK_COI_fam, measures="Observed"),FK_COI_fam@sam_data$collection_date, FK_COI_fam@sam_data$locus),c("richness","YEAR_DATE", "locus"))
#richness_12S_FK <- setNames(cbind(estimate_richness(FK_12S_fam, measures="Observed"),FK_12S_fam@sam_data$collection_date, FK_12S_fam@sam_data$locus),c("richness","YEAR_DATE", "locus"))

par(mfrow=c(1,2))
par(mar=c(4,5,2,0))
boxplot(richness_16S_FK$richness/max(richness_16S_FK$richness)~dmy(richness_16S_FK$YEAR_DATE), at=c(1,3,6,8,10,12,14,16,18,20),xaxt="n",main="", ylab=c("Relative number of taxa"),cex.axis = 0.8,las=2,xlim=c(0.5,21.5),ylim=c(0,1.1),col=cbbPalette_alpha[2])
par(new=TRUE)
boxplot(richness_18S_FK$richness/max(richness_18S_FK$richness)~ymd(richness_18S_FK$YEAR_DATE), at=c(1,3,6,8,10,12,14,16,18,20),ylim=c(0,1.1), yaxt="n",xaxt="n", col=cbbPalette_alpha[3],alpha=0.4,xlim=c(0.5,21.5))
par(new=TRUE)
boxplot(richness_COI_FK$richness/max(richness_COI_FK$richness)~ymd(richness_COI_FK$YEAR_DATE), at=c(1,3,6,8,10,12,14,16,18,20), ylim=c(0,1.1),yaxt="n",xaxt="n",col=cbbPalette_alpha[4],alpha=0.5,xlim=c(0.5,21.5))
#par(new=TRUE)
#boxplot(richness_12S_FK$richness/max(richness_12S_FK$richness)~ymd(richness_12S_FK$YEAR_DATE), at=c(1,3,6,8,10,12,14,16,18,20), ylim=c(0,1.1),xlim=c(0.5,21.5),yaxt="n",xaxt="n",col=cbbPalette_alpha[11],alpha=0.9)
legend("bottomleft",title="Locus",c("16S - microorganisms","18S - phytoplankton","COI - invertebrates","12S - vertebrates"), fill=c(cbbPalette_alpha[2],cbbPalette_alpha[3],cbbPalette_alpha[4],cbbPalette_alpha[11]),  ncol=1,cex=0.8, bty="n")
abline(v=c(10), col=c("black"), lty=c(2), lwd=c(1))
axis(side=1, at=c(1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21),
     labels=c("Apr", "May", "June", "July", "Aug","Sep", "Oct", "Nov", "Dec", "Jan", "Feb","Mar",
              "Apr", "May", "June", "July", "Aug","Sep", "Oct", "Nov", "Dec"), las=3,cex.axis=0.7)
mtext("2015", side=1, line=3, at=4,cex=0.8)
mtext("2016", side=1, line=3, at=16,cex=0.8)
legend("topleft", "A", bty="n")

#MB
richness_16S_MB <- setNames(cbind(estimate_richness(MB_16S_fam, measures="Observed"),MB_16S_fam@sam_data$collection_date, MB_16S_fam@sam_data$locus),c("richness","YEAR_DATE", "locus"))
richness_18S_MB <- setNames(cbind(estimate_richness(MB_18S_fam, measures="Observed"),MB_18S_fam@sam_data$collection_date, MB_18S_fam@sam_data$locus),c("richness","YEAR_DATE", "locus"))
richness_COI_MB <- setNames(cbind(estimate_richness(MB_COI_fam, measures="Observed"),MB_COI_fam@sam_data$collection_date, MB_COI_fam@sam_data$locus),c("richness","YEAR_DATE", "locus"))
richness_12S_MB <- setNames(cbind(estimate_richness(MB_12S_fam, measures="Observed"),MB_12S_fam@sam_data$collection_date, MB_12S_fam@sam_data$locus),c("richness","YEAR_DATE", "locus"))

par(mar=c(4,1,2,4))
boxplot(richness_16S_MB$richness/max(richness_16S_MB$richness)~ymd(richness_16S_MB$YEAR_DATE), at=c(1,4,7,9,13,17,18,21),xaxt="n",main="", cex.axis = 0.8,las=2,yaxt="n",ylim=c(0,1.1),ylab=c("Relative number of taxa"),col=cbbPalette_alpha[2])
par(new=TRUE)
boxplot(richness_18S_MB$richness/max(richness_18S_MB$richness)~ymd(richness_18S_MB$YEAR_DATE), at=c(1,4,7,9,13,17,18,21),ylim=c(0,1.1),xaxs="i", yaxt="n",xaxt="n", col=cbbPalette_alpha[3],alpha=0.4)
par(new=TRUE)
boxplot(richness_COI_MB$richness/max(richness_COI_MB$richness)~ymd(richness_COI_MB$YEAR_DATE), at=c(1,4,7,9,13,17,18,21), ylim=c(0,1.1),yaxt="n",xaxt="n",col=cbbPalette_alpha[4],alpha=0.5)
par(new=TRUE)
boxplot(richness_12S_MB$richness/max(richness_12S_MB$richness)~ymd(richness_12S_MB$YEAR_DATE), at=c(4,7,9,17,18,21), xlim=c(0.5,21.5),ylim=c(0,1.1),yaxt="n",xaxt="n",col=cbbPalette_alpha[11],alpha=0.9)
abline(v=c(10), col=c("black"), lty=c(2), lwd=c(1))
axis(side=1, at=c(1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21),
     labels=c("Apr", "May", "June", "July", "Aug","Sep", "Oct", "Nov", "Dec", "Jan", "Feb","Mar",
              "Apr", "May", "June", "July", "Aug","Sep", "Oct", "Nov", "Dec"), las=3,cex.axis=0.7)
mtext("2015", side=1, line=3, at=4,cex=0.8)
mtext("2016", side=1, line=3, at=16,cex=0.8)
legend("topleft", "B", bty="n")
```

```{r simple correlations FK and MB, message=FALSE, warning=FALSE, include=FALSE}
tmp_cor_16S_FK <- cor.test(richness_16S_FK$richness,as.numeric(FK_16S_m2w@sam_data$TMP_C),method=c("pearson"))
tmp_cor_18S_FK <- cor.test(richness_18S_FK$richness,as.numeric(FK_18S_m2w@sam_data$TMP_C),method=c("pearson"))
tmp_cor_COI_FK <- cor.test(richness_COI_FK$richness,as.numeric(FK_COI_m2w@sam_data$TMP_C),method=c("pearson"))

chl_cor_16S_FK <- cor.test(richness_16S_FK$richness,as.numeric(FK_16S_m2w@sam_data$CHL_MG_M.3),method=c("pearson"))
chl_cor_18S_FK <- cor.test(richness_18S_FK$richness,as.numeric(FK_18S_m2w@sam_data$CHL_MG_M.3),method=c("pearson"))
chl_cor_COI_FK <- cor.test(richness_COI_FK$richness,as.numeric(FK_COI_m2w@sam_data$CHL_MG_M.3),method=c("pearson"))

tmp_cor_16S_MB <- cor.test(richness_16S_MB$richness,as.numeric(MB_16S_m2w@sam_data$temp),method=c("pearson"))
tmp_cor_18S_MB <- cor.test(richness_18S_MB$richness,as.numeric(MB_18S_m2w@sam_data$temp),method=c("pearson"))
tmp_cor_COI_MB <- cor.test(richness_COI_MB$richness,as.numeric(MB_COI_m2w@sam_data$temp),method=c("pearson"))
tmp_cor_12S_MB <- cor.test(richness_12S_MB$richness,as.numeric(MB_12S_m2w@sam_data$temp),method=c("pearson"))

chl_cor_16S_MB <- cor.test(richness_16S_MB$richness,as.numeric(MB_16S_m2w@sam_data$chlorophyll),method=c("pearson"))
chl_cor_18S_MB <- cor.test(richness_18S_MB$richness,as.numeric(MB_18S_m2w@sam_data$chlorophyll),method=c("pearson"))
chl_cor_COI_MB <- cor.test(richness_COI_MB$richness,as.numeric(MB_COI_m2w@sam_data$chlorophyll),method=c("pearson"))
chl_cor_12S_MB <- cor.test(richness_12S_MB$richness,as.numeric(MB_12S_m2w@sam_data$chlorophyll),method=c("pearson"))
```

```{r pseudo autocorrelation FK and MB, echo=FALSE, fig.cap="\\label{fig:fig S2}Figure S2: Pseudo-autocorrelation of FK reference point 1 (left) and with a moving reference point (right).", fig.height=5, fig.width=6, message=FALSE, warning=FALSE}
OTUs_16S_FK<-otu_table(FK_16S_prop)
dates_16S_FK<-dmy(sample_data(FK_16S_prop)$collection_date)  #
OTUs_18S_FK<-otu_table(FK_18S_prop)
dates_18S_FK<-ymd(sample_data(FK_18S_prop)$collection_date)  #
OTUs_COI_FK<-otu_table(FK_COI_prop)
dates_COI_FK<-ymd(sample_data(FK_COI_prop)$collection_date)  #

dist.res_16S_FK <- PA(OTUs=OTUs_16S_FK, DATES=dates_16S_FK, REFERENCE = 1, METHOD="jaccard")
dist.res_18S_FK <- PA(OTUs=OTUs_18S_FK, DATES=dates_18S_FK, REFERENCE = 1, METHOD="jaccard")
dist.res_COI_FK <- PA(OTUs=OTUs_COI_FK, DATES=dates_COI_FK, REFERENCE = 1, METHOD="jaccard")
dist.res_16S_FK_sa <- OneStep(OTUs=OTUs_16S_FK, DATES=dates_16S_FK, METHOD="jaccard")
dist.res_18S_FK_sa <- OneStep(OTUs=OTUs_18S_FK, DATES=dates_18S_FK, METHOD="jaccard")
dist.res_COI_FK_sa <- OneStep(OTUs=OTUs_COI_FK, DATES=dates_COI_FK, METHOD="jaccard")

par(mfcol=c(3,2))
par(mar=c(0,4,4,0))
boxplot(dist.res_16S_FK, xlab="", ylab="Euclidian Distance", xaxt="n",ylim=c(0,1),col=cbbPalette_alpha[2], main="FK")
mtext("Reference point 1", cex=0.8)
legend("topleft",title="Locus",c("16S - microorganisms","18S - phytoplankton","COI - invertebrates"), fill=c(cbbPalette_alpha[2],cbbPalette_alpha[3],cbbPalette_alpha[4]),  ncol=1,cex=0.8, bty="n")
par(mar=c(2,4,2,0))
boxplot(dist.res_18S_FK, xlab="", ylab="Euclidian Distance",  xaxt="n",ylim=c(0,1),col=cbbPalette_alpha[3])
par(mar=c(4,4,0,0))
boxplot(dist.res_COI_FK, xlab="Elapsed Time in Days", ylab="Euclidian Distance", ylim=c(0,1),col=cbbPalette_alpha[4])

par(mar=c(0,2,4,2))
boxplot(dist.res_16S_FK_sa, ylab="", yaxt="n",ylim=c(0,1),col=cbbPalette_alpha[2],xlab="",xaxt="n", main="FK")
mtext("Moving reference",cex=0.8)
par(mar=c(2,2,2,2))
boxplot(dist.res_18S_FK_sa, ylab="", yaxt="n",ylim=c(0,1),col=cbbPalette_alpha[3],xlab="",xaxt="n")
par(mar=c(4,2,0,2))
boxplot(dist.res_COI_FK_sa, xlab="Elapsed Time in Days", yaxt="n",ylab="",xaxt="n", ylim=c(0,1),col=cbbPalette_alpha[4],xlab="")
axis(side=1, at=c(1,2,3,4,5,6,7,8,9), labels=c("49","112","56","49","70","56","77","56","56"),las=1,cex.axis=1)
```

```{r pseudo autocorrelation MB, echo=FALSE, fig.cap="\\label{fig:fig S3}Figure S3: Pseudo-autocorrelation of MB with reference point 1 (left) and moving reference point (right).", fig.height=6.5, fig.width=6, message=FALSE, warning=FALSE}
#MB 
OTUs_16S_MB<-otu_table(MB_16S_fam)
dates_16S_MB<-ymd(sample_data(MB_16S_fam)$collection_date)
OTUs_18S_MB<-otu_table(MB_18S_fam)
dates_18S_MB<-ymd(sample_data(MB_18S_fam)$collection_date)
OTUs_COI_MB<-otu_table(MB_COI_fam)
dates_COI_MB<-ymd(sample_data(MB_COI_fam)$collection_date)
OTUs_12S_MB<-otu_table(MB_12S_fam)
dates_12S_MB<-ymd(sample_data(MB_12S_fam)$collection_date)

dist.res_16S_MB <- PA(OTUs=OTUs_16S_MB, DATES=dates_16S_MB, REFERENCE = 1, METHOD="jaccard")
dist.res_18S_MB <- PA(OTUs=OTUs_18S_MB, DATES=dates_18S_MB, REFERENCE = 1, METHOD="jaccard")
dist.res_COI_MB <- PA(OTUs=OTUs_COI_MB, DATES=dates_COI_MB, REFERENCE = 1, METHOD="jaccard")
dist.res_12S_MB <- PA(OTUs=OTUs_12S_MB, DATES=dates_12S_MB, REFERENCE = 1, METHOD="jaccard")
dist.res_16S_MB_sa <- OneStep(OTUs=OTUs_16S_MB, DATES=dates_16S_MB, METHOD="jaccard")
dist.res_18S_MB_sa <- OneStep(OTUs=OTUs_18S_MB, DATES=dates_18S_MB, METHOD="jaccard")
dist.res_COI_MB_sa <- OneStep(OTUs=OTUs_COI_MB, DATES=dates_COI_MB, METHOD="jaccard")
dist.res_12S_MB_sa <- OneStep(OTUs=OTUs_12S_MB, DATES=dates_12S_MB, METHOD="jaccard")

#plot object in base R
par(mfcol=c(4,2))
par(mar=c(0,4,4,0))
boxplot(dist.res_16S_MB, xaxt="n",ylim=c(0,1),main="MB",col=cbbPalette_alpha[2],xlim=c(0.5,8.5), ylab="Euclidian Distance", ylim=c(0,1))
mtext("Reference point 1",cex=0.8)
par(mar=c(1,4,3,0))
boxplot(dist.res_18S_MB, xlab="", ylab="Euclidian Distance", xlim=c(0.5,8.5), ylim=c(0,1), col=cbbPalette_alpha[3],xaxt="n")
par(mar=c(2,4,2,0))
boxplot(dist.res_COI_MB, xlab="", ylab="Euclidian Distance", ylim=c(0,1), col=cbbPalette_alpha[4], xlim=c(0.5,8.5),xaxt="n")
par(mar=c(4,4,0,0))
boxplot(dist.res_12S_MB, xlab="Elapsed Time in Days", xaxt="n",ylab="Euclidian Distance",at=c(2,3,4,6,7,8),xlim=c(0.5,8.5), ylim=c(0,1),col=cbbPalette_alpha[11])
axis(side=1, at=c(1,2,3,4,5,6,7,8), labels=c("0","68","133","229","357","489","515","594"),las=1,cex.axis=1)

par(mar=c(0,2,4,2))
boxplot(dist.res_16S_MB_sa, ylab="", main="MB", ylim=c(0,1),col=cbbPalette_alpha[2],xlab="",yaxt="n",xaxt="n",xlim=c(0.5,7.5))
legend("bottomright",title="Locus",c("16S - microorganisms","18S - phytoplankton","COI - invertebrates","12S - vertebrates"), fill=c(cbbPalette_alpha[2],cbbPalette_alpha[3],cbbPalette_alpha[4],cbbPalette_alpha[11]),  ncol=1,cex=0.8, bty="n")
mtext("Moving reference",cex=0.8)
par(mar=c(1,2,3,2))
boxplot(dist.res_18S_MB_sa, ylab="", ylim=c(0,1),col=cbbPalette_alpha[3],xlab="",yaxt="n",xaxt="n",xlim=c(0.5,7.5))
par(mar=c(2,2,2,2))
boxplot(dist.res_COI_MB_sa, xlab="", ylab="",xaxt="n", ylim=c(0,1),col=cbbPalette_alpha[4],xlab="",yaxt="n",xlim=c(0.5,7.5))
par(mar=c(4,2,0,2))
boxplot(dist.res_12S_MB_sa, xlab="Elapsed time in days",yaxt="n", ylab="",at=c(2,3,4,6,7),xlim=c(0.5,7.5), ylim=c(0,1),col=cbbPalette_alpha[11], xaxt="n",xaxs='i')
axis(side=1, at=c(1,2,3,4,5,6,7), labels=c("68","65","96","128","132","26","79"),las=1,cex.axis=1)
```

```{r ordination plot of all data, eval=FALSE, fig.cap="\\label{fig:fig S4}Figure S4: Ordination on Jaccard distances for the complete dataset for both locations. Orange is Florida, fig.width=4, message=FALSE, warning=FALSE, blue is Monterey. This figure is not for publishing, I made it to see how different the communities are between the locations.", fig.height=4, include=FALSE}
plot_ordination(all_data, all_Data.ord, title="NMDS both locations, Jaccard", col="env_package",label="collection_date") + theme_bw() + scale_color_manual(values=c(cbbPalette[3],cbbPalette[2])) + theme(legend.position="none")
```

```{r dendrogram of top taxa, eval=FALSE, fig.cap="\\label{fig:fig S5}Figure S5: Dendrogram of the top 100 taxa for FK top and MB bottom.", fig.height=6, fig.width=10, message=FALSE, warning=FALSE, include=FALSE}
clust_FK <- vegdist(t(data.frame(top_taxa_merge_FK@otu_table)),"jaccard")
clust_FK <- hclust(clust_FK)
plot(clust_FK)
#hclust.h.d_FK <- as.dendrogram(hclust(clust_FK,method="average")) #make dendrogram
#ggdendrogram(hclust.h.d_FK,leaf_labels=TRUE)

clust_MB <- vegdist(t(data.frame(top_taxa_merge_MB@otu_table)),"jaccard")
clust_MB <- hclust(clust_MB)
plot(clust_MB)
#hclust.h.d_MB <- as.dendrogram(clust_MB,method="average") #make dendrogram
#ggdendrogram(hclust.h.d_MB,leaf_labels=TRUE)

```

<!--All other datasets had the following p-values, Florida Keys: 18S p = `r tmp_cor_18S_FK[3]`, COI p = `r tmp_cor_COI_FK[3]`, and 12S p = ?, Monterey Bay: 16S p = `r tmp_cor_16S_MB[3]`, COI p = `r tmp_cor_COI_MB[3]`, and 12S p = `r tmp_cor_12S_MB[3]`, p = `r tmp_cor_18S_MB[3]`, p = `r chl_cor_16S_MB[3]`-->